{% extends "game_base.html" %}
{% comment %}
[CLAUDE:OPTIMIZATION_LAYER:START]
This template is part of the core_user_system component
See .claude/README.md for more information
[CLAUDE:OPTIMIZATION_LAYER:END]
{% endcomment %}

{% load static %}

{% block title %}Unified Market System - EudaimoniaGo{% endblock %}

{% block css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/market_store.css' %}">
{% endblock css %}

{% block content %}
<div class="container py-4">
  <!-- Header Section -->
  <div class="row mb-xl">
    <div class="col-golden-primary">
      <h1 class="market-page-title">Unified Market System</h1>
      <p class="market-lead mb-md">The central hub for all transactions, requests, and exchanges within Aion.</p>
    </div>
    <div class="col-golden-secondary d-flex align-items-center justify-content-lg-end mt-3 mt-lg-0">
      <a href="#request-form" class="btn btn-eudaimonia me-2">
        <i class="fas fa-plus me-2"></i>Make a Request
      </a>
      <a href="{% url 'core:wishlist' %}" class="btn btn-outline-primary position-relative">
        <i class="fas fa-heart me-2"></i>My Wishlist
        {% if wishlist_count > 0 %}
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="wishlist-count">
            {{ wishlist_count }}
          </span>
        {% endif %}
      </a>
    </div>
  </div>
  
  <!-- Search Bar -->
  <div class="search-container">
    <input type="text" id="market-search" class="form-control" placeholder="Search for items, services, experiences..." aria-label="Search the marketplace">
    <button id="search-button" class="btn btn-eudaimonia position-absolute" style="right: 5px; top: 5px; bottom: 5px;">
      <i class="fas fa-search"></i>
    </button>
  </div>
  
  <!-- Current Economic Layer Section -->
  <div class="market-section mb-lg">
    <h2 class="section-title">
      <span id="current-layer-title">All Market Items</span> 
      <span class="badge bg-primary rounded-pill ms-2" id="items-count">{{ filtered_count|default:total_items_count }}</span>
    </h2>
    
    <!-- Layer Navigation -->
    <div class="layer-nav mb-md">
      <div class="layer-nav-item active" data-layer="all">All Layers</div>
      <div class="layer-nav-item" data-layer="outer">Port City</div>
      <div class="layer-nav-item" data-layer="middle">Laws Model</div>
      <div class="layer-nav-item" data-layer="inner">Republic Model</div>
    </div>
    
    {% csrf_token %}
    
    <!-- Economic Layers Section -->
    <div class="market-section mb-lg">
      <h2 class="section-title">Economic Layers</h2>
      <div class="row-golden">
        <!-- Port City Card -->
        <div class="col-golden-secondary mb-md-0 mb-4">
          <div class="market-layer-card outer-layer">
            <div class="card-overlay bg-port-city"></div>
            <div class="card-body">
              <h3 class="layer-title">Port City</h3>
              <p class="layer-subtitle mb-md">Traditional Marketplace</p>
              <p>Open trading system with traditional currency exchanges.</p>
            </div>
            <div class="card-footer">
              <button class="btn btn-light w-100" id="port-city-btn" data-layer="outer">
                Browse Port City
              </button>
            </div>
          </div>
        </div>

        <!-- Laws Model and Republic Model Cards in golden ratio container -->
        <div class="col-golden-primary">
          <div class="row-golden">
            <!-- Laws Model Card -->
            <div class="col-golden-primary mb-md-0 mb-4">
              <div class="market-layer-card middle-layer">
                <div class="card-overlay bg-middle-city"></div>
                <div class="card-body">
                  <h3 class="layer-title">Laws Model</h3>
                  <p class="layer-subtitle mb-md">Semi-Closed Economy</p>
                  <p>Status-based economic system with merit-based resource allocation.</p>
                </div>
                <div class="card-footer">
                  <button class="btn btn-light w-100" id="laws-model-btn" data-layer="middle">
                    Browse Laws Model
                  </button>
                </div>
              </div>
            </div>

            <!-- Republic Model Card -->
            <div class="col-golden-secondary">
              <div class="market-layer-card inner-layer">
                <div class="card-overlay bg-inner-city"></div>
                <div class="card-body">
                  <h3 class="layer-title">Republic Model</h3>
                  <p class="layer-subtitle mb-md">Common Ownership</p>
                  <p>Collective resource allocation with community-driven priorities.</p>
                </div>
                <div class="card-footer">
                  <button class="btn btn-light w-100" id="republic-model-btn" data-layer="inner">
                    Browse Republic Model
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Layer Progression Section -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="card progress-card">
          <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
              <h4 class="mb-0">Your Economic Layer Journey</h4>
              <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#progressionInfoModal">
                <i class="fas fa-info-circle me-1"></i>How It Works
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-7">
                <!-- Progress Path Visualization -->
                <div class="progression-path position-relative mb-4">
                  <div class="progress-track"></div>
                  
                  <!-- Layer Milestones -->
                  <div class="milestone-wrapper">
                    <div class="milestone milestone-outer active">
                      <div class="milestone-icon">
                        <i class="fas fa-ship"></i>
                      </div>
                      <div class="milestone-info">
                        <h6>Port City</h6>
                        <span class="text-success">Access Granted</span>
                      </div>
                    </div>
                    
                    <div class="milestone milestone-middle">
                      <div class="milestone-icon">
                        <i class="fas fa-building"></i>
                      </div>
                      <div class="milestone-info">
                        <h6>Laws Model</h6>
                        <span class="text-muted">65% Complete</span>
                      </div>
                    </div>
                    
                    <div class="milestone milestone-inner">
                      <div class="milestone-icon">
                        <i class="fas fa-hands-holding-circle"></i>
                      </div>
                      <div class="milestone-info">
                        <h6>Republic Model</h6>
                        <span class="text-muted">25% Complete</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Current Layer Status -->
                <div class="current-status">
                  <h5 class="mb-3">Your Current Status</h5>
                  <div class="d-flex mb-2">
                    <div class="flex-shrink-0">
                      <span class="badge bg-warning text-dark p-2">Port City</span>
                    </div>
                    <div class="ms-3">
                      <h6 class="mb-1">Full Access</h6>
                      <p class="small text-muted mb-0">You can access all resources in this layer</p>
                    </div>
                  </div>
                  
                  <div class="d-flex mb-2">
                    <div class="flex-shrink-0">
                      <span class="badge bg-primary p-2">Laws Model</span>
                    </div>
                    <div class="ms-3">
                      <h6 class="mb-1">Class II Citizen</h6>
                      <p class="small text-muted mb-0">Limited resource access and ownership rights</p>
                    </div>
                  </div>
                  
                  <div class="d-flex">
                    <div class="flex-shrink-0">
                      <span class="badge bg-success p-2">Republic Model</span>
                    </div>
                    <div class="ms-3">
                      <h6 class="mb-1">Observer Status</h6>
                      <p class="small text-muted mb-0">Limited to educational resources only</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-5">
                <!-- Next Steps -->
                <div class="next-steps-card">
                  <h5 class="mb-3">Next Steps to Advance</h5>
                  <ul class="list-group next-steps-list mb-4">
                    <li class="list-group-item d-flex align-items-center">
                      <div class="step-icon bg-primary">
                        <i class="fas fa-handshake"></i>
                      </div>
                      <div class="ms-3">
                        <h6 class="mb-1">Complete 3 more structured exchanges</h6>
                        <p class="small text-muted mb-0">To reach Class III in Laws Model</p>
                      </div>
                    </li>
                    <li class="list-group-item d-flex align-items-center">
                      <div class="step-icon bg-primary">
                        <i class="fas fa-book"></i>
                      </div>
                      <div class="ms-3">
                        <h6 class="mb-1">Complete the "Laws & Economy" course</h6>
                        <p class="small text-muted mb-0">Required for Class III promotion</p>
                      </div>
                    </li>
                    <li class="list-group-item d-flex align-items-center">
                      <div class="step-icon bg-success">
                        <i class="fas fa-users"></i>
                      </div>
                      <div class="ms-3">
                        <h6 class="mb-1">Participate in 2 collective decisions</h6>
                        <p class="small text-muted mb-0">To gain contributor status in Republic Model</p>
                      </div>
                    </li>
                  </ul>
                  
                  <a href="#" class="btn btn-eudaimonia btn-sm w-100">View Detailed Progression Path</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Featured Categories -->
    <div class="row mb-4">
      <div class="col-12">
        <h3 class="mb-3">Browse Categories</h3>
        <div>
          <a href="#" class="category-tag"><i class="fas fa-box me-1"></i>Physical Goods</a>
          <a href="#" class="category-tag"><i class="fas fa-tools me-1"></i>Services</a>
          <a href="#" class="category-tag"><i class="fas fa-laptop-code me-1"></i>Digital Assets</a>
          <a href="#" class="category-tag"><i class="fas fa-coins me-1"></i>Investments</a>
          <a href="#" class="category-tag"><i class="fas fa-brain me-1"></i>Skills & Knowledge</a>
          <a href="#" class="category-tag"><i class="fas fa-star me-1"></i>Experiences</a>
          <a href="#" class="category-tag"><i class="fas fa-hands-helping me-1"></i>Collaborative Opportunities</a>
          <a href="#" class="category-tag"><i class="fas fa-share-alt me-1"></i>Resource Sharing</a>
        </div>
      </div>
    </div>
    
    <!-- Personalized Recommendations -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="mb-0">Recommended For You</h3>
          <span class="badge bg-primary p-2"><i class="fas fa-sync-alt me-1"></i>Based on your activity</span>
        </div>
        
        <div class="recommendations-carousel">
          <div class="row">
            <!-- Recommendation 1 -->
            <div class="col-md-3 mb-4">
              <div class="market-item recommendation-item">
                <div class="ribbon-wrapper">
                  <div class="ribbon ribbon-primary">Recommended</div>
                </div>
                <div class="market-item-image bg-market-item3"></div>
                <div class="p-3">
                  <div class="small text-primary mb-1"><i class="fas fa-bolt me-1"></i>Perfect match for your interests</div>
                  <h5 class="mb-2">Philosophy Symposium</h5>
                  <p class="text-muted small mb-2">Experience • Weekly Event</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-light text-dark">Merit Access</span>
                    <button class="btn btn-sm btn-primary">View Details</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Recommendation 2 -->
            <div class="col-md-3 mb-4">
              <div class="market-item recommendation-item">
                <div class="ribbon-wrapper">
                  <div class="ribbon ribbon-primary">Recommended</div>
                </div>
                <div class="market-item-image bg-market-item5"></div>
                <div class="p-3">
                  <div class="small text-primary mb-1"><i class="fas fa-users me-1"></i>Popular in your cohort</div>
                  <h5 class="mb-2">Citizen Plot Ownership</h5>
                  <p class="text-muted small mb-2">Property • Limited Availability</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-light text-dark">Class III Required</span>
                    <button class="btn btn-sm btn-primary">View Details</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Recommendation 3 -->
            <div class="col-md-3 mb-4">
              <div class="market-item recommendation-item">
                <div class="ribbon-wrapper">
                  <div class="ribbon ribbon-primary">Recommended</div>
                </div>
                <div class="market-item-image bg-market-item7"></div>
                <div class="p-3">
                  <div class="small text-primary mb-1"><i class="fas fa-lightbulb me-1"></i>Based on your skills</div>
                  <h5 class="mb-2">Research Collaboration</h5>
                  <p class="text-muted small mb-2">Opportunity • Open Enrollment</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-light text-dark">Contribution Based</span>
                    <button class="btn btn-sm btn-primary">View Details</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Recommendation 4 -->
            <div class="col-md-3 mb-4">
              <div class="market-item recommendation-item">
                <div class="ribbon-wrapper">
                  <div class="ribbon ribbon-primary">Recommended</div>
                </div>
                <div class="market-item-image bg-market-item4"></div>
                <div class="p-3">
                  <div class="small text-primary mb-1"><i class="fas fa-history me-1"></i>Based on recent search</div>
                  <h5 class="mb-2">Coding Mentorship</h5>
                  <p class="text-muted small mb-2">Service • 5 Sessions</p>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-light text-dark">50 Credits</span>
                    <button class="btn btn-sm btn-primary">View Details</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Search and Filters Section -->
    <div class="filter-card">
      <h3 class="filter-title">
        <i class="fas fa-filter"></i>Search & Filter
      </h3>
      
      <!-- Active Filters Section -->
      <div id="active-filters" class="mb-md" style="display: none;">
        <p class="mb-sm small text-muted">Active Filters:</p>
        <div id="filter-tags"></div>
      </div>
      
      <form id="filter-form" class="filter-form">
        <div class="row g-3">
          <!-- Search Input -->
          <div class="col-md-6">
            <div class="search-container">
              <input type="text" class="form-control" id="market-search" name="search" placeholder="Search for items..." value="{{ request.GET.search }}">
              <button type="submit" class="btn btn-primary" id="search-button">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          
          <!-- Category Filter -->
          <div class="col-md-3">
            <select class="form-select" id="category-filter" name="category">
              <option value="">All Categories</option>
              {% for cat_code, cat_name in category_choices %}
                <option value="{{ cat_code }}" {% if request.GET.category == cat_code %}selected{% endif %}>{{ cat_name }}</option>
              {% endfor %}
            </select>
          </div>
          
          <!-- Layer Filter -->
          <div class="col-md-3">
            <select class="form-select" id="layer-filter" name="layer">
              <option value="">All Layers</option>
              <option value="outer" {% if request.GET.layer == 'outer' %}selected{% endif %}>Outer Layer</option>
              <option value="middle" {% if request.GET.layer == 'middle' %}selected{% endif %}>Middle Layer</option>
              <option value="inner" {% if request.GET.layer == 'inner' %}selected{% endif %}>Inner Layer</option>
            </select>
          </div>
          
          <!-- Sort By -->
          <div class="col-md-2">
            <select class="form-select" id="sort-by" name="sort">
              <option value="recommended" {% if request.GET.sort == 'recommended' or not request.GET.sort %}selected{% endif %}>Recommended</option>
              <option value="newest" {% if request.GET.sort == 'newest' %}selected{% endif %}>Newest</option>
              <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>Name (A-Z)</option>
            </select>
          </div>
          
          <!-- Apply Filters Button -->
          <div class="col-md-1">
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-check"></i>
            </button>
          </div>
        </div>
        
        <!-- Advanced Filters (Collapsible) -->
        <div class="mt-3">
          <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#advancedFilters" role="button" aria-expanded="false">
            <i class="fas fa-sliders-h me-1"></i>Advanced Filters
          </a>
          
          <div class="collapse mt-3" id="advancedFilters">
            <div class="row g-3">
              <!-- Rank Requirements -->
              <div class="col-md-3">
                <label class="form-label small">Rank Requirements</label>
                <select class="form-select" id="rank-filter" name="rank">
                  <option value="">Any Rank</option>
                  <option value="1" {% if request.GET.rank == '1' %}selected{% endif %}>Rank 1 Only</option>
                  <option value="2" {% if request.GET.rank == '2' %}selected{% endif %}>Rank 2+</option>
                  <option value="3" {% if request.GET.rank == '3' %}selected{% endif %}>Rank 3+</option>
                  <option value="4" {% if request.GET.rank == '4' %}selected{% endif %}>Rank 4 Only</option>
                </select>
              </div>
              
              <!-- Availability -->
              <div class="col-md-3">
                <label class="form-label small">Availability</label>
                <select class="form-select" id="availability-filter" name="availability">
                  <option value="">All Items</option>
                  <option value="available" {% if request.GET.availability == 'available' %}selected{% endif %}>Available Now</option>
                  <option value="limited" {% if request.GET.availability == 'limited' %}selected{% endif %}>Limited Time Only</option>
                </select>
              </div>
              
              <!-- Price Type -->
              <div class="col-md-3">
                <label class="form-label small">Price Type</label>
                <select class="form-select" id="price-type-filter" name="price_type">
                  <option value="">All Types</option>
                  <option value="credits" {% if request.GET.price_type == 'credits' %}selected{% endif %}>Credits</option>
                  <option value="merit" {% if request.GET.price_type == 'merit' %}selected{% endif %}>Merit-Based</option>
                  <option value="contribution" {% if request.GET.price_type == 'contribution' %}selected{% endif %}>Contribution-Based</option>
                </select>
              </div>
              
              <!-- Action Buttons -->
              <div class="col-md-3 d-flex align-items-end">
                <button type="button" id="reset-filters" class="btn btn-outline-secondary w-100">
                  <i class="fas fa-redo me-1"></i>Reset All Filters
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    
    <!-- Store Content - Main Layout with Golden Ratio -->
    <div class="store-layout">
      <!-- Sidebar filters - takes up golden-section-sm (38.2%) of the width -->
      <div class="store-sidebar">
        <div class="filter-card mb-lg">
          <!-- Filter content goes here -->
          <!-- ... existing filter content ... -->
        </div>
      </div>
      
      <!-- Main content - takes up golden-section-lg (61.8%) of the width -->
      <div class="store-main-content">
        <!-- Featured items, grid, etc go here -->
        <!-- ... existing content ... -->
        
        <!-- Market Items Grid with Golden Ratio -->
        <div class="market-items-container" id="market-items-container">
          {% for item in filtered_items %}
            <div class="market-item" data-item-id="{{ item.id }}" data-layer="{{ item.economic_layer }}" data-category="{{ item.category }}">
              <!-- Market item content -->
              <!-- ... existing item content ... -->
            </div>
          {% empty %}
            <div id="no-results-message" class="col-12">
              <div class="alert alert-info p-4 text-center">
                <i class="fas fa-search mb-3" style="font-size: 2rem;"></i>
                <h4>No items found</h4>
                <p>Try adjusting your filters or search criteria.</p>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    
    <!-- Request Form Section -->
    <div class="row mb-5" id="request-form">
      <div class="col-lg-8 mx-auto">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">Make a Request</h4>
          </div>
          <div class="card-body">
            <p class="text-muted mb-4">Request any experience, good, service, or resource. Our smart matching system will connect you with potential providers.</p>
            
            <form>
              <div class="mb-3">
                <label for="requestType" class="form-label">Request Type</label>
                <select class="form-select" id="requestType">
                  <option selected>Select request type...</option>
                  <option value="good">Physical Good</option>
                  <option value="service">Service</option>
                  <option value="digital">Digital Asset</option>
                  <option value="experience">Experience</option>
                  <option value="resource">Resource Sharing</option>
                  <option value="skill">Knowledge/Skill</option>
                  <option value="collaboration">Collaboration</option>
                </select>
              </div>
              
              <div class="mb-3">
                <label for="requestLayer" class="form-label">Economic Layer</label>
                <select class="form-select" id="requestLayer">
                  <option selected>Select economic layer...</option>
                  <option value="outer">Outer Layer - Port City (Conventional Exchange)</option>
                  <option value="middle">Middle Layer - Laws Model (Four Wealth Classes)</option>
                  <option value="inner">Inner Layer - Republic Model (Common Ownership)</option>
                </select>
              </div>
              
              <div class="mb-3">
                <label for="requestTitle" class="form-label">Request Title</label>
                <input type="text" class="form-control" id="requestTitle" placeholder="Enter a clear, concise title">
              </div>
              
              <div class="mb-3">
                <label for="requestDescription" class="form-label">Description</label>
                <textarea class="form-control" id="requestDescription" rows="4" placeholder="Describe your request in detail..."></textarea>
              </div>
              
              <div class="mb-3">
                <label for="requestTags" class="form-label">Tags (Optional)</label>
                <input type="text" class="form-control" id="requestTags" placeholder="Enter tags separated by commas">
                <div class="form-text">Adding relevant tags helps match your request with providers.</div>
              </div>
              
              <div class="mb-3">
                <label for="requestTimeframe" class="form-label">Timeframe (Optional)</label>
                <select class="form-select" id="requestTimeframe">
                  <option selected>Select timeframe...</option>
                  <option value="immediate">Immediate (within 24 hours)</option>
                  <option value="week">Within a week</option>
                  <option value="month">Within a month</option>
                  <option value="flexible">Flexible</option>
                </select>
              </div>
              
              <div class="text-end">
                <button type="button" class="btn btn-secondary me-2">Cancel</button>
                <button type="submit" class="btn btn-eudaimonia">Submit Request</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <!-- My Activity Section -->
    <div class="row mb-5" id="my-requests">
      <div class="col-12">
        <h3 class="mb-4">My Market Activity</h3>
        <ul class="nav nav-tabs mb-4">
          <li class="nav-item">
            <a class="nav-link active" href="#">My Requests</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">My Offerings</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Transactions</a>
          </li>
        </ul>
        
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>Your market activity will appear here once you've made requests or offerings.
        </div>
      </div>
    </div>
</div>

<!-- Economic Layer Progression Info Modal -->
<div class="modal fade" id="progressionInfoModal" tabindex="-1" aria-labelledby="progressionInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="progressionInfoModalLabel">Economic Layer Progression System</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-12">
            <h5 class="mb-3">Understanding the Three Economic Layers</h5>
            <p>The Unified Market System in Aion is structured into three distinct economic layers, each representing a different philosophical approach to economic exchange and value.</p>
          </div>
        </div>
        
        <div class="row mb-4">
          <div class="col-md-4 mb-3 mb-md-0">
            <div class="card h-100 outer-layer-light">
              <div class="card-body">
                <h5 class="card-title">Port City (Outer Layer)</h5>
                <p class="card-text small">The traditional marketplace model where goods and services are exchanged using conventional currency. Similar to Republic X's Appetitive part of the soul, focused on material goods and immediate satisfaction.</p>
                <h6 class="mt-3">Access Requirements:</h6>
                <ul class="small">
                  <li>Open to all players</li>
                  <li>No special qualifications</li>
                  <li>Pay-to-play model</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="col-md-4 mb-3 mb-md-0">
            <div class="card h-100 middle-layer-light">
              <div class="card-body">
                <h5 class="card-title">Laws Model (Middle Layer)</h5>
                <p class="card-text small">A semi-closed economy based on Plato's Laws, featuring structured class systems and property rights with both ownership and corresponding responsibilities.</p>
                <h6 class="mt-3">Access Requirements:</h6>
                <ul class="small">
                  <li>Complete 5 transactions in Port City</li>
                  <li>Gain approval from two existing citizens</li>
                  <li>Complete "Economic Citizenship" course</li>
                  <li>Have positive contribution score</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="card h-100 inner-layer-light">
              <div class="card-body">
                <h5 class="card-title">Republic Model (Inner Layer)</h5>
                <p class="card-text small">Based on Plato's Republic with common ownership and merit-based resource allocation, reflecting the Rational part of the soul's governance.</p>
                <h6 class="mt-3">Access Requirements:</h6>
                <ul class="small">
                  <li>Reach Class III in Laws Model</li>
                  <li>Contribute to 3+ community projects</li>
                  <li>Demonstrate philosophical understanding</li>
                  <li>Receive approval from governing council</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mb-4">
          <div class="col-12">
            <h5 class="mb-3">Class System Within Laws Model</h5>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Class</th>
                    <th>Rights & Privileges</th>
                    <th>Responsibilities</th>
                    <th>Advancement Requirements</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><strong>Class I</strong></td>
                    <td>Basic resource access, limited participation rights</td>
                    <td>Resource maintenance, community service</td>
                    <td>Entry level, acceptance of fundamental civic principles</td>
                  </tr>
                  <tr>
                    <td><strong>Class II</strong></td>
                    <td>Resource ownership rights, voting on local matters</td>
                    <td>Resource improvement, mentoring Class I citizens</td>
                    <td>3 months as Class I, complete civic education, positive contributions</td>
                  </tr>
                  <tr>
                    <td><strong>Class III</strong></td>
                    <td>Extended property rights, voting on governance</td>
                    <td>Community leadership, education responsibilities</td>
                    <td>6 months as Class II, significant contributions, peer recognition</td>
                  </tr>
                  <tr>
                    <td><strong>Class IV</strong></td>
                    <td>Full governance participation, leadership eligibility</td>
                    <td>System maintenance, dispute resolution, guardian duties</td>
                    <td>1 year as Class III, exemplary service, council approval</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-12">
            <h5 class="mb-3">Your Progress Tracking</h5>
            <p>Your progress through each economic layer is tracked through various metrics:</p>
            <ul>
              <li><strong>Contribution Score</strong> - Measures your positive impact on the community</li>
              <li><strong>Knowledge Assessment</strong> - Evaluates your understanding of each layer's principles</li>
              <li><strong>Peer Recognition</strong> - Acknowledgment from other community members</li>
              <li><strong>Consistent Participation</strong> - Regular engagement with the layer's activities</li>
            </ul>
            <p class="mb-0">Progress is reviewed quarterly by the Citizen Council, with feedback provided to help you advance.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a href="#" class="btn btn-eudaimonia">View My Detailed Progress</a>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block javascript %}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize variables
    const searchInput = document.getElementById('search-input');
    const clearSearchBtn = document.getElementById('clear-search');
    const categoryFilter = document.getElementById('category-filter');
    const layerFilter = document.getElementById('layer-filter');
    const sortBySelect = document.getElementById('sort-by');
    const rankFilter = document.getElementById('rank-filter');
    const availabilityFilter = document.getElementById('availability-filter');
    const priceTypeFilter = document.getElementById('price-type-filter');
    const resetFiltersBtn = document.getElementById('reset-filters');
    const filterForm = document.getElementById('market-filter-form');
    const activeFiltersContainer = document.getElementById('active-filters');
    
    // Function to build and display active filter tags
    function updateActiveFilterTags() {
      // Clear existing tags
      activeFiltersContainer.innerHTML = '';
      
      const activeTags = [];
      
      // Check each filter
      if (searchInput.value) {
        activeTags.push({
          type: 'search',
          label: `Search: ${searchInput.value}`,
          value: searchInput.value
        });
      }
      
      if (categoryFilter.value) {
        const selectedOption = categoryFilter.options[categoryFilter.selectedIndex];
        activeTags.push({
          type: 'category',
          label: `Category: ${selectedOption.text}`,
          value: categoryFilter.value
        });
      }
      
      if (layerFilter.value) {
        const selectedOption = layerFilter.options[layerFilter.selectedIndex];
        activeTags.push({
          type: 'layer',
          label: `Layer: ${selectedOption.text}`,
          value: layerFilter.value
        });
      }
      
      if (rankFilter.value) {
        const selectedOption = rankFilter.options[rankFilter.selectedIndex];
        activeTags.push({
          type: 'rank',
          label: `${selectedOption.text}`,
          value: rankFilter.value
        });
      }
      
      if (availabilityFilter.value) {
        const selectedOption = availabilityFilter.options[availabilityFilter.selectedIndex];
        activeTags.push({
          type: 'availability',
          label: `${selectedOption.text}`,
          value: availabilityFilter.value
        });
      }
      
      if (priceTypeFilter.value) {
        const selectedOption = priceTypeFilter.options[priceTypeFilter.selectedIndex];
        activeTags.push({
          type: 'price_type',
          label: `${selectedOption.text}`,
          value: priceTypeFilter.value
        });
      }
      
      // Create and append tags if there are any active filters
      if (activeTags.length > 0) {
        const tagsHTML = activeTags.map(tag => `
          <span class="badge bg-primary me-2 mb-2 p-2">
            ${tag.label}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    data-filter-type="${tag.type}" data-filter-value="${tag.value}" 
                    aria-label="Remove filter"></button>
          </span>
        `).join('');
        
        activeFiltersContainer.innerHTML = tagsHTML;
        
        // Add event listeners to close buttons
        document.querySelectorAll('#active-filters .btn-close').forEach(btn => {
          btn.addEventListener('click', function() {
            const filterType = this.getAttribute('data-filter-type');
            
            // Clear the corresponding filter
            switch (filterType) {
              case 'search':
                searchInput.value = '';
                break;
              case 'category':
                categoryFilter.value = '';
                break;
              case 'layer':
                layerFilter.value = '';
                break;
              case 'rank':
                rankFilter.value = '';
                break;
              case 'availability':
                availabilityFilter.value = '';
                break;
              case 'price_type':
                priceTypeFilter.value = '';
                break;
            }
            
            // Submit the form to apply changes
            filterForm.submit();
          });
        });
      }
    }
    
    // Initialize active filter tags
    updateActiveFilterTags();
    
    // Handle clearing search
    clearSearchBtn.addEventListener('click', function() {
      searchInput.value = '';
      filterForm.submit();
    });
    
    // Handle reset filters
    resetFiltersBtn.addEventListener('click', function() {
      searchInput.value = '';
      categoryFilter.value = '';
      layerFilter.value = '';
      sortBySelect.value = 'recommended';
      rankFilter.value = '';
      availabilityFilter.value = '';
      priceTypeFilter.value = '';
      filterForm.submit();
    });
    
    // Auto-submit on filter change for better UX
    const autoSubmitElements = [
      categoryFilter, 
      layerFilter, 
      sortBySelect,
      rankFilter,
      availabilityFilter,
      priceTypeFilter
    ];
    
    autoSubmitElements.forEach(element => {
      element.addEventListener('change', function() {
        filterForm.submit();
      });
    });
    
    // Search on Enter key
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        filterForm.submit();
      }
    });
    
    // Wishlist functionality
    const wishlistButtons = document.querySelectorAll('.wishlist-toggle');
    
    wishlistButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        
        const itemId = this.getAttribute('data-item-id');
        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        
        fetch('{% url "core:toggle_wishlist" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
          },
          body: `item_id=${itemId}`
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // Update button appearance
            if (data.is_in_wishlist) {
              this.innerHTML = '<i class="fas fa-heart"></i>';
              this.classList.add('active');
            } else {
              this.innerHTML = '<i class="far fa-heart"></i>';
              this.classList.remove('active');
            }
            
            // Update wishlist count in header if it exists
            const wishlistCountBadge = document.getElementById('wishlist-count');
            if (wishlistCountBadge) {
              wishlistCountBadge.textContent = data.wishlist_count;
            }
            
            // Show toast notification
            const toastHTML = `
              <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
                <div class="toast align-items-center text-white ${data.is_in_wishlist ? 'bg-success' : 'bg-primary'}" role="alert" aria-live="assertive" aria-atomic="true">
                  <div class="d-flex">
                    <div class="toast-body">
                      <i class="${data.is_in_wishlist ? 'fas fa-heart' : 'fas fa-heart-broken'} me-2"></i>
                      ${data.message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                  </div>
                </div>
              </div>
            `;
            
            // Insert toast into DOM
            document.body.insertAdjacentHTML('beforeend', toastHTML);
            
            // Initialize and show the toast
            const toastElement = document.body.lastElementChild.querySelector('.toast');
            const toast = new bootstrap.Toast(toastElement, {
              autohide: true,
              delay: 3000
            });
            toast.show();
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while updating your wishlist.');
        });
      });
    });
  });
</script>
{% endblock javascript %} 
